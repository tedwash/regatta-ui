var racingApp=angular.module("racingApp",["ngRoute","racingControllers","racingServices"]);var racingControllers=angular.module("racingControllers",["LocalStorageModule"]);var racingServices=angular.module("racingServices",[]);racingApp.run(["$window","$location","$rootScope",function(e,t,n){n.$on("$routeChangeSuccess",function(r,i,s){if(i.$$route){n.title=i.$$route.title}if(t.$$path.indexOf("events")>-1)n.nav="events";else if(t.$$path.indexOf("crews")>-1)n.nav="crews";e.ga("send","pageview",{page:t.path()})});n.baseUrl=props.BASE_URL}]);racingApp.config(["$routeProvider",function(e){e.when("/events",{templateUrl:"views/event-list.html",controller:"EventListCtrl",title:"Events"}).when("/events/:eventId",{templateUrl:"views/event-detail.html",controller:"EventDetailCtrl",title:"Event"}).when("/events/:eventId/races/:raceId",{templateUrl:"views/race-detail.html",controller:"RaceDetailCtrl",title:"Race"}).when("/events/:eventId/races/:raceId/:crewId",{templateUrl:"views/race-detail.html",controller:"RaceDetailCtrl",title:"Race"}).when("/crews/:crewId",{templateUrl:"views/crew.html",controller:"CrewCtrl",title:"Crew"}).when("/crews",{templateUrl:"views/crew-list.html",controller:"CrewListCtrl",title:"Crews"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",title:"About"}).otherwise({redirectTo:"/events"})}]);racingControllers.controller("EventListCtrl",["$rootScope","$scope","eventListService","raceListService",function(e,t,n,r){e.loading=true;var i=true;n.getEventList(function(n){t.events=n;if(!i)e.loading=false;else i=false});r.getUpcomingRaces(3,function(n){t.races=n;if(!i)e.loading=false;else i=false})}]);racingControllers.controller("EventDetailCtrl",["$rootScope","$scope","$routeParams","eventDetailService","eventListService",function(e,t,n,r,i){var s=n.eventId;e.loading=true;r.getRaceList(s,function(n,r){t.event=r;e.loading=false;e.title=r.name})}]);racingControllers.controller("AboutCtrl",["$rootScope","$scope",function(e,t){}]);racingControllers.controller("RaceDetailCtrl",["$rootScope","$scope","$routeParams","raceListService","raceDetailService","localStorageService",function(e,t,n,r,i,s){var o=n.eventId;var u=n.raceId;t.calloutCrew=n.crewId;var a=o+""+u;if(s.get("pageId")==a)t.showReload=true;else t.showReload=false;s.add("pageId",a);e.loading=true;i.getRaceDetail(o,u,function(n,r,i){t.race=i;e.loading=false;e.title=i.type_name+(i.type<3?" "+i.event_type_index:"")+" - "+i.event_name});t.reloadResults=function(){e.loading=true;i.getRaceDetail(n.eventId,n.raceId,function(n,r,i){t.race=i;e.loading=false})};t.toHumanTime=function(e){var t=e/1e3%60;t=+t.toFixed(3);if(t<=10)t="0"+t;var n=Math.floor(e/(1e3*60)%60);return n+":"+t};t.placeSuffix=function(e){switch(e){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}]);racingControllers.controller("CrewCtrl",["$rootScope","$scope","$routeParams","crewService",function(e,t,n,r){var i=n.crewId;e.loading=true;r.getCrew(i,function(n,r){t.crew=r;e.loading=false});t.bladeStyle={backgroundColor:"white"}}]);racingControllers.controller("CrewListCtrl",["$rootScope","$scope","crewService",function(e,t,n){e.loading=true;n.getCrewList(function(n){t.crews=n;e.loading=false})}]);var TEST=false;var devProps={BASE_URL:"https://dl.dropboxusercontent.com/u/3115379/vails_demo",EXT:".json"};var props=prdProps;if(TEST)props=devProps;var LANE_COUNT=6;var OFFSET_MINS=5;racingServices.service("raceListService",["$http","$q",function(e,t){function i(e,t){var n=Date.parse(e.timestamp);var r=Date.parse(t.timestamp);if(n<r)return-1;if(n>r)return 1;return 0}var n;var r=function(t){e({method:"GET",url:props.BASE_URL+"/races"+props.EXT}).success(function(e){e.sort(i);n=e;return t(n)})};var s=function(e,t){var n=new Date;if(TEST){n.setYear(2013);n.setMonth(4);n.setDate(10)}var r=n.getMinutes()-OFFSET_MINS;n.setMinutes(r);var i;angular.forEach(e,function(e,t){var r=Date.parse(e.timestamp);if(n>=r)i=t});return e.slice(i,i+t)};var o=function(e,t){var n;angular.forEach(e,function(e,r){if(e.id==t)n=e});return n};return{getUpcomingRaces:function(e,i){if(n){return i(s(n,e))}else{var o=t.defer();r(function(e){o.resolve(e)});o.promise.then(function(t){i(s(n,e))})}},getRace:function(e,i){if(n){return i(o(n,e))}else{var s=t.defer();r(function(e){s.resolve(e)});s.promise.then(function(t){return i(o(t,e))})}}}}]);racingServices.service("eventListService",["$http","$q",function(e,t){var n;var r=function(t){e({method:"GET",url:props.BASE_URL+"/events"+props.EXT}).success(function(e){n=e;return t(n)})};var i=function(e,t){var n;angular.forEach(e,function(e,r){if(e.id==t)n=e});return n};return{getEventList:function(e){if(n){return e(n)}else{var i=t.defer();r(function(e){i.resolve(e)});i.promise.then(function(t){return e(t)})}},getEvent:function(e,s){if(n){return s(i(n,e))}else{var o=t.defer();r(function(e){o.resolve(e)});o.promise.then(function(t){return s(i(t,e))})}}}}]);racingServices.service("eventDetailService",["$http","$q",function(e,t){var n={};var r=function(t,r){e({method:"GET",url:props.BASE_URL+"/events/"+t+""+props.EXT}).success(function(e){var i={left:[],right:[]};var s=false;var o;angular.forEach(e.race_types,function(e,t){e.timestamp=new Date(e.races[0].timestamp);if(o!=e.timestamp.getDay()){e.showDay=true;o=e.timestamp.getDay();s=!s}if(s)i.left.push(e);else i.right.push(e)});e.race_types=i;n[t]=e;return r(t,n[t])})};return{getRaceList:function(e,i){if(n[e]){return i(e,n[e])}else{var s=t.defer();r(e,function(e,t){s.resolve(t)});s.promise.then(function(t){return i(e,t)})}}}}]);racingServices.service("raceDetailService",["$http","$q",function(e,t){var n=function(t,n,r){e({method:"GET",url:props.BASE_URL+"/races/"+n+""+props.EXT}).success(function(e){var s=[];var o=e.length>6?e.length:6;for(i=0;i<o;i++){s.push({index:i+1})}angular.forEach(e.lanes,function(e,t){s[e.index-1]=e});e.lanes=s;return r(t,n,e)})};return{getRaceDetail:function(e,r,i){var s=t.defer();n(e,r,function(e,t,n){s.resolve(n)});s.promise.then(function(t){return i(e,r,t)})}}}]);racingServices.service("crewService",["$http","$q",function(e,t){var n;var r=function(t,n){e({method:"GET",url:props.BASE_URL+"/universities/"+t+""+props.EXT}).success(function(e){return n(t,e)})};var i=function(t){e({method:"GET",url:props.BASE_URL+"/universities"+props.EXT}).success(function(e){return t(e)})};return{getCrew:function(e,n){var i=t.defer();r(e,function(e,t){i.resolve(t)});i.promise.then(function(t){return n(e,t)})},getCrewList:function(e){if(n){return e(n)}else{var r=t.defer();i(function(e){r.resolve(e)});r.promise.then(function(t){return e(t)})}}}}])